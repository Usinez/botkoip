<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Фотоотчёт</title>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <style>
        body {
            margin: 0;
            padding: 0;
            font-family: Arial, sans-serif;
            background: #000;
            height: 100vh;
            display: flex;
            flex-direction: column;
        }

        #cameraWrapper {
            flex: 1;
            position: relative;
            overflow: hidden;
        }

        #cameraPreview {
            width: 100%;
            height: 100%;
            object-fit: cover;
            transform: scaleX(-1);
        }

        .controls {
            position: fixed;
            bottom: 20px;
            width: 100%;
            display: flex;
            justify-content: center;
            gap: 20px;
            padding: 10px;
            box-sizing: border-box;
        }

        button {
            width: 60px;
            height: 60px;
            border: none;
            border-radius: 50%;
            background: #007bff;
            color: white;
            font-size: 24px;
            cursor: pointer;
            box-shadow: 0 2px 5px rgba(0,0,0,0.3);
            transition: transform 0.2s;
        }

        button:active {
            transform: scale(0.95);
        }

        .alert {
            position: fixed;
            top: 20px;
            left: 50%;
            transform: translateX(-50%);
            background: rgba(255, 0, 0, 0.9);
            color: white;
            padding: 12px 24px;
            border-radius: 8px;
            max-width: 90%;
            text-align: center;
            display: none;
            z-index: 1000;
        }

        .loader {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0,0,0,0.8);
            display: none;
            justify-content: center;
            align-items: center;
            flex-direction: column;
            color: white;
            font-size: 18px;
            z-index: 2000;
        }

        .loader-spinner {
            width: 40px;
            height: 40px;
            border: 4px solid #f3f3f3;
            border-top: 4px solid #3498db;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin-bottom: 15px;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
    </style>
</head>
<body>
    <div class="alert" id="alert"></div>
    <div class="loader" id="loader">
        <div class="loader-spinner"></div>
        <span>Обработка...</span>
    </div>

    <div id="cameraWrapper">
        <video id="cameraPreview" autoplay playsinline muted></video>
    </div>

    <div class="controls">
        <button id="btnSwitchCamera">🔄</button>
        <button id="btnCapture">📸</button>
    </div>

    <script>
        const tg = window.Telegram.WebApp;
        let currentStream = null;
        let currentCamera = 'environment';
        let geolocationReceived = false;

        // Инициализация приложения
        async function initializeApp() {
            try {
                // Инициализация Telegram WebApp
                tg.expand();
                tg.enableClosingConfirmation();

                // Запрос разрешений
                await requestPermissions();
                
                // Старт камеры
                await startCamera();
                
                // Запрос геолокации
                await requestGeolocation();

            } catch (error) {
                showAlert(error.message);
            }
        }

        // Запрос необходимых разрешений
        async function requestPermissions() {
            try {
                // Проверка поддержки API
                if (!navigator.mediaDevices || !navigator.mediaDevices.getUserMedia) {
                    throw new Error('Ваше устройство не поддерживает камеру');
                }

                // Проверка разрешения на камеру
                const cameraPermission = await navigator.permissions.query({ name: 'camera' });
                if (cameraPermission.state === 'denied') {
                    throw new Error('Доступ к камере запрещён. Измените настройки разрешений.');
                }

                // Проверка разрешения на геолокацию
                const geoPermission = await navigator.permissions.query({ name: 'geolocation' });
                if (geoPermission.state === 'denied') {
                    throw new Error('Доступ к геолокации запрещён. Измените настройки разрешений.');
                }

            } catch (error) {
                throw new Error(`Ошибка разрешений: ${error.message}`);
            }
        }

        // Запуск камеры
        async function startCamera() {
            try {
                if (currentStream) {
                    currentStream.getTracks().forEach(track => track.stop());
                }

                const constraints = {
                    video: {
                        facingMode: currentCamera,
                        width: { ideal: 1280 },
                        height: { ideal: 720 }
                    }
                };

                currentStream = await navigator.mediaDevices.getUserMedia(constraints);
                document.getElementById('cameraPreview').srcObject = currentStream;

                // Ожидание готовности видео
                await new Promise((resolve) => {
                    const video = document.getElementById('cameraPreview');
                    video.onloadedmetadata = resolve;
                });

            } catch (error) {
                throw new Error(`Ошибка камеры: ${error.message}`);
            }
        }

        // Получение геолокации
        async function requestGeolocation() {
            return new Promise((resolve, reject) => {
                navigator.geolocation.getCurrentPosition(
                    position => {
                        geolocationReceived = true;
                        resolve(position);
                    },
                    error => {
                        let message = 'Ошибка геолокации: ';
                        switch (error.code) {
                            case error.PERMISSION_DENIED:
                                message += 'Доступ запрещён';
                                break;
                            case error.POSITION_UNAVAILABLE:
                                message += 'Данные недоступны';
                                break;
                            case error.TIMEOUT:
                                message += 'Таймаут запроса';
                                break;
                            default:
                                message += 'Неизвестная ошибка';
                        }
                        reject(new Error(message));
                    },
                    {
                        enableHighAccuracy: true,
                        timeout: 10000,
                        maximumAge: 0
                    }
                );
            });
        }

        // Создание фото
        async function capturePhoto() {
            showLoader(true);
            try {
                const video = document.getElementById('cameraPreview');
                const canvas = document.createElement('canvas');
                const context = canvas.getContext('2d');

                // Настройка canvas
                canvas.width = video.videoWidth;
                canvas.height = video.videoHeight;
                context.drawImage(video, 0, 0, canvas.width, canvas.height);

                // Получение геоданных
                const geoData = await new Promise((resolve, reject) => {
                    navigator.geolocation.getCurrentPosition(
                        position => resolve(position),
                        error => reject(new Error('Не удалось получить геолокацию')),
                        { enableHighAccuracy: true, timeout: 5000 }
                    );
                });

                // Формирование данных
                const photoData = {
                    photo: canvas.toDataURL('image/jpeg', 0.9),
                    lat: geoData.coords.latitude,
                    lon: geoData.coords.longitude,
                    accuracy: geoData.coords.accuracy,
                    timestamp: new Date().toISOString()
                };

                // Отправка в бот
                tg.sendData(JSON.stringify(photoData));
                tg.close();

            } catch (error) {
                showAlert(error.message);
            } finally {
                showLoader(false);
            }
        }

        // Вспомогательные функции
        function showAlert(message, duration = 5000) {
            const alert = document.getElementById('alert');
            alert.textContent = message;
            alert.style.display = 'block';
            setTimeout(() => alert.style.display = 'none', duration);
        }

        function showLoader(show) {
            document.getElementById('loader').style.display = show ? 'flex' : 'none';
        }

        // Обработчики событий
        document.getElementById('btnSwitchCamera').addEventListener('click', async () => {
            currentCamera = currentCamera === 'environment' ? 'user' : 'environment';
            await startCamera();
        });

        document.getElementById('btnCapture').addEventListener('click', capturePhoto);

        // Старт приложения
        document.addEventListener('DOMContentLoaded', initializeApp);
    </script>
</body>
</html>
