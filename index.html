<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>–§–æ—Ç–æ–æ—Ç—á—ë—Ç</title>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <style>
        body {
            margin: 0;
            padding: 0;
            font-family: Arial, sans-serif;
            background: #000;
            height: 100vh;
            display: flex;
            flex-direction: column;
        }

        #cameraWrapper {
            flex: 1;
            position: relative;
            overflow: hidden;
        }

        #cameraPreview {
            width: 100%;
            height: 100%;
            object-fit: cover;
            transform: scaleX(-1);
        }

        .controls {
            position: fixed;
            bottom: 20px;
            width: 100%;
            display: flex;
            justify-content: center;
            gap: 20px;
            padding: 10px;
            box-sizing: border-box;
        }

        button {
            width: 60px;
            height: 60px;
            border: none;
            border-radius: 50%;
            background: #007bff;
            color: white;
            font-size: 24px;
            cursor: pointer;
            box-shadow: 0 2px 5px rgba(0,0,0,0.3);
            transition: transform 0.2s;
        }

        button:active {
            transform: scale(0.95);
        }

        .alert {
            position: fixed;
            top: 20px;
            left: 50%;
            transform: translateX(-50%);
            background: rgba(255, 0, 0, 0.9);
            color: white;
            padding: 12px 24px;
            border-radius: 8px;
            max-width: 90%;
            text-align: center;
            display: none;
            z-index: 1000;
        }

        .loader {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0,0,0,0.8);
            display: none;
            justify-content: center;
            align-items: center;
            flex-direction: column;
            color: white;
            font-size: 18px;
            z-index: 2000;
        }

        .loader-spinner {
            width: 40px;
            height: 40px;
            border: 4px solid #f3f3f3;
            border-top: 4px solid #3498db;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin-bottom: 15px;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
    </style>
</head>
<body>
    <div class="alert" id="alert"></div>
    <div class="loader" id="loader">
        <div class="loader-spinner"></div>
        <span>–û–±—Ä–∞–±–æ—Ç–∫–∞...</span>
    </div>

    <div id="cameraWrapper">
        <video id="cameraPreview" autoplay playsinline muted></video>
    </div>

    <div class="controls">
        <button id="btnSwitchCamera">üîÑ</button>
        <button id="btnCapture">üì∏</button>
    </div>

    <script>
        const tg = window.Telegram.WebApp;
        let currentStream = null;
        let currentCamera = 'environment';
        let geolocationReceived = false;

        // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è
        async function initializeApp() {
            try {
                // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è Telegram WebApp
                tg.expand();
                tg.enableClosingConfirmation();

                // –ó–∞–ø—Ä–æ—Å —Ä–∞–∑—Ä–µ—à–µ–Ω–∏–π
                await requestPermissions();
                
                // –°—Ç–∞—Ä—Ç –∫–∞–º–µ—Ä—ã
                await startCamera();
                
                // –ó–∞–ø—Ä–æ—Å –≥–µ–æ–ª–æ–∫–∞—Ü–∏–∏
                await requestGeolocation();

            } catch (error) {
                showAlert(error.message);
            }
        }

        // –ó–∞–ø—Ä–æ—Å –Ω–µ–æ–±—Ö–æ–¥–∏–º—ã—Ö —Ä–∞–∑—Ä–µ—à–µ–Ω–∏–π
        async function requestPermissions() {
            try {
                // –ü—Ä–æ–≤–µ—Ä–∫–∞ –ø–æ–¥–¥–µ—Ä–∂–∫–∏ API
                if (!navigator.mediaDevices || !navigator.mediaDevices.getUserMedia) {
                    throw new Error('–í–∞—à–µ —É—Å—Ç—Ä–æ–π—Å—Ç–≤–æ –Ω–µ –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç –∫–∞–º–µ—Ä—É');
                }

                // –ü—Ä–æ–≤–µ—Ä–∫–∞ —Ä–∞–∑—Ä–µ—à–µ–Ω–∏—è –Ω–∞ –∫–∞–º–µ—Ä—É
                const cameraPermission = await navigator.permissions.query({ name: 'camera' });
                if (cameraPermission.state === 'denied') {
                    throw new Error('–î–æ—Å—Ç—É–ø –∫ –∫–∞–º–µ—Ä–µ –∑–∞–ø—Ä–µ—â—ë–Ω. –ò–∑–º–µ–Ω–∏—Ç–µ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ —Ä–∞–∑—Ä–µ—à–µ–Ω–∏–π.');
                }

                // –ü—Ä–æ–≤–µ—Ä–∫–∞ —Ä–∞–∑—Ä–µ—à–µ–Ω–∏—è –Ω–∞ –≥–µ–æ–ª–æ–∫–∞—Ü–∏—é
                const geoPermission = await navigator.permissions.query({ name: 'geolocation' });
                if (geoPermission.state === 'denied') {
                    throw new Error('–î–æ—Å—Ç—É–ø –∫ –≥–µ–æ–ª–æ–∫–∞—Ü–∏–∏ –∑–∞–ø—Ä–µ—â—ë–Ω. –ò–∑–º–µ–Ω–∏—Ç–µ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ —Ä–∞–∑—Ä–µ—à–µ–Ω–∏–π.');
                }

            } catch (error) {
                throw new Error(`–û—à–∏–±–∫–∞ —Ä–∞–∑—Ä–µ—à–µ–Ω–∏–π: ${error.message}`);
            }
        }

        // –ó–∞–ø—É—Å–∫ –∫–∞–º–µ—Ä—ã
        async function startCamera() {
            try {
                if (currentStream) {
                    currentStream.getTracks().forEach(track => track.stop());
                }

                const constraints = {
                    video: {
                        facingMode: currentCamera,
                        width: { ideal: 1280 },
                        height: { ideal: 720 }
                    }
                };

                currentStream = await navigator.mediaDevices.getUserMedia(constraints);
                document.getElementById('cameraPreview').srcObject = currentStream;

                // –û–∂–∏–¥–∞–Ω–∏–µ –≥–æ—Ç–æ–≤–Ω–æ—Å—Ç–∏ –≤–∏–¥–µ–æ
                await new Promise((resolve) => {
                    const video = document.getElementById('cameraPreview');
                    video.onloadedmetadata = resolve;
                });

            } catch (error) {
                throw new Error(`–û—à–∏–±–∫–∞ –∫–∞–º–µ—Ä—ã: ${error.message}`);
            }
        }

        // –ü–æ–ª—É—á–µ–Ω–∏–µ –≥–µ–æ–ª–æ–∫–∞—Ü–∏–∏
        async function requestGeolocation() {
            return new Promise((resolve, reject) => {
                navigator.geolocation.getCurrentPosition(
                    position => {
                        geolocationReceived = true;
                        resolve(position);
                    },
                    error => {
                        let message = '–û—à–∏–±–∫–∞ –≥–µ–æ–ª–æ–∫–∞—Ü–∏–∏: ';
                        switch (error.code) {
                            case error.PERMISSION_DENIED:
                                message += '–î–æ—Å—Ç—É–ø –∑–∞–ø—Ä–µ—â—ë–Ω';
                                break;
                            case error.POSITION_UNAVAILABLE:
                                message += '–î–∞–Ω–Ω—ã–µ –Ω–µ–¥–æ—Å—Ç—É–ø–Ω—ã';
                                break;
                            case error.TIMEOUT:
                                message += '–¢–∞–π–º–∞—É—Ç –∑–∞–ø—Ä–æ—Å–∞';
                                break;
                            default:
                                message += '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–∞—è –æ—à–∏–±–∫–∞';
                        }
                        reject(new Error(message));
                    },
                    {
                        enableHighAccuracy: true,
                        timeout: 10000,
                        maximumAge: 0
                    }
                );
            });
        }

        // –°–æ–∑–¥–∞–Ω–∏–µ —Ñ–æ—Ç–æ
        async function capturePhoto() {
            showLoader(true);
            try {
                const video = document.getElementById('cameraPreview');
                const canvas = document.createElement('canvas');
                const context = canvas.getContext('2d');

                // –ù–∞—Å—Ç—Ä–æ–π–∫–∞ canvas
                canvas.width = video.videoWidth;
                canvas.height = video.videoHeight;
                context.drawImage(video, 0, 0, canvas.width, canvas.height);

                // –ü–æ–ª—É—á–µ–Ω–∏–µ –≥–µ–æ–¥–∞–Ω–Ω—ã—Ö
                const geoData = await new Promise((resolve, reject) => {
                    navigator.geolocation.getCurrentPosition(
                        position => resolve(position),
                        error => reject(new Error('–ù–µ —É–¥–∞–ª–æ—Å—å –ø–æ–ª—É—á–∏—Ç—å –≥–µ–æ–ª–æ–∫–∞—Ü–∏—é')),
                        { enableHighAccuracy: true, timeout: 5000 }
                    );
                });

                // –§–æ—Ä–º–∏—Ä–æ–≤–∞–Ω–∏–µ –¥–∞–Ω–Ω—ã—Ö
                const photoData = {
                    photo: canvas.toDataURL('image/jpeg', 0.9),
                    lat: geoData.coords.latitude,
                    lon: geoData.coords.longitude,
                    accuracy: geoData.coords.accuracy,
                    timestamp: new Date().toISOString()
                };

                // –û—Ç–ø—Ä–∞–≤–∫–∞ –≤ –±–æ—Ç
                tg.sendData(JSON.stringify(photoData));
                tg.close();

            } catch (error) {
                showAlert(error.message);
            } finally {
                showLoader(false);
            }
        }

        // –í—Å–ø–æ–º–æ–≥–∞—Ç–µ–ª—å–Ω—ã–µ —Ñ—É–Ω–∫—Ü–∏–∏
        function showAlert(message, duration = 5000) {
            const alert = document.getElementById('alert');
            alert.textContent = message;
            alert.style.display = 'block';
            setTimeout(() => alert.style.display = 'none', duration);
        }

        function showLoader(show) {
            document.getElementById('loader').style.display = show ? 'flex' : 'none';
        }

        // –û–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ —Å–æ–±—ã—Ç–∏–π
        document.getElementById('btnSwitchCamera').addEventListener('click', async () => {
            currentCamera = currentCamera === 'environment' ? 'user' : 'environment';
            await startCamera();
        });

        document.getElementById('btnCapture').addEventListener('click', capturePhoto);

        // –°—Ç–∞—Ä—Ç –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è
        document.addEventListener('DOMContentLoaded', initializeApp);
    </script>
</body>
</html>
